# 基本設計書

## RAG教育クイズアプリ

| 項目       | 内容                         |
| ---------- | ---------------------------- |
| 作成日     | 2026/02/16                   |
| バージョン | 1.0                          |

---

## 1. システム構成図

### 1.1 ローカル開発構成

```
┌─────────────────────────────────────────────────────────┐
│                     ブラウザ (Chrome)                     │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Next.js フロントエンド                   │ │
│  │         http://localhost:3000                        │ │
│  │                                                     │ │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │ │
│  │   │ トップ   │  │ QA画面   │  │ クイズ画面       │ │ │
│  │   │ 画面     │  │(チャット)│  │(出題・回答・判定)│ │ │
│  │   └──────────┘  └──────────┘  └──────────────────┘ │ │
│  └──────────────────────┬──────────────────────────────┘ │
└─────────────────────────┼────────────────────────────────┘
                          │ HTTP (REST API)
                          ▼
┌─────────────────────────────────────────────────────────┐
│              Python バックエンド (FastAPI)                │
│              http://localhost:7000                        │
│                                                          │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│   │ /api/ask     │  │ /api/quiz    │  │ /api/quiz    │ │
│   │ 質問応答API  │  │ /generate    │  │ /evaluate    │ │
│   │              │  │ クイズ生成   │  │ クイズ判定   │ │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│          │                 │                  │          │
│   ┌──────▼─────────────────▼──────────────────▼───────┐ │
│   │              RAG パイプライン                       │ │
│   │  ① クエリ解析  ② ベクトル検索  ③ コンテキスト構築 │ │
│   │  ④ LLM回答生成 / クイズ生成 / 判定                 │ │
│   └──────┬────────────────────────────────┬────────────┘ │
│          │                                │              │
│   ┌──────▼───────┐                 ┌──────▼───────┐     │
│   │  ChromaDB    │                 │  Bedrock     │     │
│   │ (ベクトルDB) │                 │  (AWS LLM)   │     │
│   └──────────────┘                 └──────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 1.2 AWS クラウド構成（本番）

```
ユーザー (ブラウザ)
    │
    ▼
┌──────────────────────┐
│  AWS Amplify         │ ← Next.js ホスティング
│  (フロントエンド)    │   ビルド済みを自動デプロイ
└──────────┬───────────┘
           │ HTTPS
           ▼
┌──────────────────────┐     ┌──────────────────────┐
│  API Gateway         │────>│  AWS Lambda           │
│  (REST API)          │     │  (FastAPI)            │
└──────────────────────┘     │                       │
                             │  ┌─────────────────┐  │
                             │  │ RAGパイプライン  │  │
                             │  │ ① クエリ解析    │  │
                             │  │ ② ベクトル検索  │  │
                             │  │ ③ コンテキスト  │  │
                             │  │ ④ LLM呼び出し   │  │
                             │  └──┬──────────┬───┘  │
                             └─────┼──────────┼──────┘
                                   │          │
                    ┌──────────────┘          └──────────────┐
                    ▼                                        ▼
        ┌───────────────────┐                   ┌───────────────────┐
        │ Amazon Bedrock    │                   │ Amazon OpenSearch  │
        │ (LLM)             │                   │ Serverless         │
        │                   │                   │ (ベクトル検索)     │
        │ Claude 3.5 Haiku  │                   │                   │
        │ or Titan           │                   │ Titan Embedding   │
        └───────────────────┘                   └───────────────────┘
                                                         │
                                                         │ データ取込
                                                         │
        ┌───────────────────┐    ┌──────────┐           │
        │  S3               │───>│  Lambda   │──────────┘
        │  (PDF保存)        │    │  (OCR +   │
        │                   │    │  チャンク) │
        └───────────────────┘    └──────────┘
```

### 1.3 AWS構成 サービス対応表

| レイヤー         | ローカル             | AWS                              |
| ---------------- | -------------------- | -------------------------------- |
| フロントエンド   | Next.js (localhost)  | **AWS Amplify**                  |
| API ゲートウェイ | 直接接続             | **API Gateway**                  |
| バックエンド     | FastAPI (localhost)  | **AWS Lambda** (Mangum)          |
| LLM              | Bedrock API          | **Amazon Bedrock**               |
| Embedding        | HuggingFace (ローカル) | **Bedrock Titan Embeddings**   |
| ベクトルDB       | ChromaDB (ファイル)  | **OpenSearch Serverless**        |
| PDF保存          | GCS / ローカル       | **S3**                           |
| OCR              | GCP Vision API       | **Amazon Textract**              |
| 認証（v2）       | なし                 | **Amazon Cognito**               |
| 監視             | なし                 | **CloudWatch**                   |

データ取込（事前処理）:
```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────────┐
│ PDF      │ →  │ Textract │ →  │ チャンク │ →  │ OpenSearch   │
│ (S3)     │    │ (OCR)    │    │ 分割     │    │ Serverless   │
│          │    │          │    │ (JSON)   │    │ (ベクトル登録)│
└──────────┘    └──────────┘    └──────────┘    └──────────────┘
```

---

## 2. 画面設計

### 2.1 トップ画面

```
┌────────────────────────────────────────┐
│                                        │
│          RAG 教育クイズアプリ           │
│                                        │
│    ┌──────────────────────────────┐    │
│    │    📖 マニュアルに質問する    │    │
│    └──────────────────────────────┘    │
│                                        │
│    ┌──────────────────────────────┐    │
│    │    📝 理解度テストを受ける    │    │
│    └──────────────────────────────┘    │
│                                        │
└────────────────────────────────────────┘
```

### 2.2 QA画面（チャット形式）

```
┌────────────────────────────────────────┐
│  ← 戻る     マニュアルQ&A              │
├────────────────────────────────────────┤
│                                        │
│  👤 有給休暇の申請方法は？              │
│                                        │
│  🤖 有給休暇の申請方法は以下の通りです。│
│     1. 勤怠システムにログイン           │
│     2. 「休暇申請」を選択              │
│     3. ...                             │
│                                        │
│     📄 出典: 就業規則マニュアル p.12    │
│                                        │
│  👤 承認フローは？                      │
│                                        │
│  🤖 承認フローは...                     │
│                                        │
├────────────────────────────────────────┤
│  ┌──────────────────────────┐ [送信]   │
│  │ 質問を入力...            │          │
│  └──────────────────────────┘          │
└────────────────────────────────────────┘
```

### 2.3 クイズ画面

```
┌────────────────────────────────────────┐
│  ← 戻る     理解度テスト               │
├────────────────────────────────────────┤
│                                        │
│  難易度を選択してください:              │
│  [初級]  [中級]  [上級]                │
│                                        │
├────────────────────────────────────────┤
│                                        │
│  Q1. 有給休暇の付与日数は、入社後      │
│      6ヶ月でどのくらいですか？          │
│                                        │
│  ┌──────────────────────────┐ [回答]   │
│  │ 回答を入力...            │          │
│  └──────────────────────────┘          │
│                                        │
│  ✅ 正解！                              │
│  10日です。労働基準法により...           │
│                                        │
│  ❌ 不正解                              │
│  正解は「10日」です。                   │
│  📄 解説: 労働基準法第39条により...      │
│                                        │
│  ────────────────────────────          │
│  スコア: 3/5 (60%)                     │
│                                        │
│  [次の問題]  [終了する]                │
│                                        │
└────────────────────────────────────────┘
```

---

## 3. データフロー

### 3.1 質問応答フロー

```
ユーザー            Next.js           FastAPI          ベクトルDB      Bedrock
  │                   │                  │                 │              │
  │ 質問入力          │                  │                 │              │
  │──────────────────>│                  │                 │              │
  │                   │ POST /api/ask    │                 │              │
  │                   │─────────────────>│                 │              │
  │                   │                  │ ベクトル検索    │              │
  │                   │                  │────────────────>│              │
  │                   │                  │ 関連チャンク    │              │
  │                   │                  │<────────────────│              │
  │                   │                  │                 │              │
  │                   │                  │ プロンプト生成+回答要求        │
  │                   │                  │────────────────────────────────>│
  │                   │                  │            回答テキスト        │
  │                   │                  │<────────────────────────────────│
  │                   │ 回答+出典JSON    │                 │              │
  │                   │<─────────────────│                 │              │
  │ 回答表示          │                  │                 │              │
  │<──────────────────│                  │                 │              │
```

### 3.2 クイズフロー

```
ユーザー            Next.js           FastAPI          ベクトルDB      Bedrock
  │                   │                  │                 │              │
  │ 難易度選択        │                  │                 │              │
  │──────────────────>│                  │                 │              │
  │                   │ POST /api/quiz   │                 │              │
  │                   │ /generate        │                 │              │
  │                   │─────────────────>│                 │              │
  │                   │                  │ ランダム取得    │              │
  │                   │                  │────────────────>│              │
  │                   │                  │ チャンク群      │              │
  │                   │                  │<────────────────│              │
  │                   │                  │                 │              │
  │                   │                  │ クイズ生成プロンプト           │
  │                   │                  │────────────────────────────────>│
  │                   │                  │           問題テキスト         │
  │                   │                  │<────────────────────────────────│
  │                   │ 問題JSON         │                 │              │
  │                   │<─────────────────│                 │              │
  │ 問題表示          │                  │                 │              │
  │<──────────────────│                  │                 │              │
  │                   │                  │                 │              │
  │ 回答入力          │                  │                 │              │
  │──────────────────>│                  │                 │              │
  │                   │ POST /api/quiz   │                 │              │
  │                   │ /evaluate        │                 │              │
  │                   │─────────────────>│                 │              │
  │                   │                  │ 判定プロンプト（問題+正解+回答）│
  │                   │                  │────────────────────────────────>│
  │                   │                  │           判定結果             │
  │                   │                  │<────────────────────────────────│
  │                   │ 判定+解説JSON    │                 │              │
  │                   │<─────────────────│                 │              │
  │ 結果表示          │                  │                 │              │
  │<──────────────────│                  │                 │              │
```

---

## 4. ディレクトリ構成

```
RAG_Education/
├── docs/                          # ドキュメント
│   ├── 00_requirements_overview.md  # PM要件整理
│   ├── 01_requirements.md           # 要件定義書
│   ├── 02_basic_design.md           # 基本設計書（本書）
│   ├── 03_api_design.md             # API設計書
│   └── 04_test_spec.md              # テスト仕様メモ
│
├── frontend/                      # Next.js フロントエンド
│   ├── package.json
│   ├── next.config.js
│   ├── src/
│   │   ├── app/
│   │   │   ├── page.tsx             # トップ画面
│   │   │   ├── qa/
│   │   │   │   └── page.tsx         # QA画面
│   │   │   ├── quiz/
│   │   │   │   └── page.tsx         # クイズ画面
│   │   │   └── layout.tsx
│   │   ├── components/              # 共通コンポーネント
│   │   └── lib/
│   │       └── api.ts               # バックエンドAPI呼び出し
│   └── public/
│
├── backend/                       # Python バックエンド
│   ├── requirements.txt
│   ├── main.py                      # FastAPI エントリポイント
│   ├── src/
│   │   ├── rag_engine.py            # RAGパイプライン
│   │   ├── quiz_engine.py           # クイズ生成・判定
│   │   ├── llm_client.py            # LLMクライアント (Bedrock)
│   │   ├── data_loader.py           # チャンクデータ読み込み
│   │   └── config.py                # 設定定数
│   ├── prompts/                     # プロンプトテンプレート
│   │   ├── qa_answer.txt
│   │   ├── quiz_generate.txt
│   │   └── quiz_evaluate.txt
│   └── data/                        # 教育マニュアルチャンク
│       └── *.json
│
├── data/                          # 生データ（PDF等）
│   └── *.pdf
│
└── README.md
```

---

## 5. 使用モデル

### 5.1 ローカル開発（HuggingFace + Bedrock API）

| 用途          | モデル                           | 備考                         |
| ------------- | -------------------------------- | ---------------------------- |
| LLM（回答）  | Bedrock: Claude 3.5 Haiku        | AWS API経由・高速・低コスト  |
| Embedding     | HuggingFace: multilingual-e5-base| ローカル実行・多言語対応     |
| ベクトルDB    | ChromaDB                         | ローカルファイル             |

### 5.2 AWS本番

| 用途          | モデル                           | 備考                         |
| ------------- | -------------------------------- | ---------------------------- |
| LLM（回答）  | Bedrock: Claude 3.5 Haiku        | 低レイテンシ・日本語◎       |
| LLM（予備）  | Bedrock: Amazon Titan Text       | フォールバック用             |
| Embedding     | Bedrock: Titan Embeddings V2     | マネージド・スケーラブル     |
| ベクトルDB    | OpenSearch Serverless             | サーバーレス・自動スケール   |

### 5.3 Bedrock モデルアクセス有効化

AWSコンソールで以下のモデルアクセスを申請する:
1. Amazon Bedrock → Model access → 「Manage model access」
2. 以下にチェック:
   - **Anthropic Claude 3.5 Haiku**
   - **Amazon Titan Text G1 - Express**
   - **Amazon Titan Embeddings G1 - Text v2**
3. 「Save changes」で申請（即時〜数分で有効化）

---

---

## 6. AWS デプロイ手順（概要）

### 6.1 前提条件

- AWSアカウント作成済み
- AWS CLI インストール済み & `aws configure` 設定済み
- リージョン: `ap-northeast-1`（東京）

### 6.2 デプロイ順序

```
1. Bedrock モデルアクセス有効化
2. S3 バケット作成（PDF保存用）
3. OpenSearch Serverless コレクション作成
4. Lambda 関数デプロイ（FastAPI + Mangum）
5. API Gateway 設定
6. Amplify でフロントエンドデプロイ
```

### 6.3 ローカル→AWS 切替の実装差分

```python
# config.py で環境変数により切り替え
import os

ENV = os.getenv("APP_ENV", "local")  # "local" or "aws"

if ENV == "aws":
    LLM_PROVIDER = "bedrock"
    VECTOR_DB = "opensearch"
    EMBEDDING_PROVIDER = "bedrock"
else:
    LLM_PROVIDER = "bedrock"       # ローカルでもBedrock APIを使用
    VECTOR_DB = "chroma"
    EMBEDDING_PROVIDER = "huggingface"
```

---

## 変更履歴

| 日付       | バージョン | 内容                      |
| ---------- | ---------- | ------------------------- |
| 2026/02/16 | 1.0        | 初版作成                  |
| 2026/02/16 | 1.1        | AWS構成追加（Bedrock/Lambda/Amplify） |
