# 2026/02/17 学習記録

## 本日のテーマ
**ローカルRAG → AWS Bedrock Knowledge Bases への完全移行**

---

## タイムライン

### 【01:00】S3 Vectors + Bedrock KB ハンズオン開始
- 参考: DevelopersIO「Amazon S3 Vectors をベクトルストアにした Amazon Bedrock Knowledge Bases のノーコード RAG 構築をゼロから解説」
- 構成: S3汎用バケット（データソース） + S3ベクトルバケット + Bedrock KB
- リージョン: us-east-1（バージニア北部）

### 【01:30】S3 アップロード機能を実装
- 送信先: `s3://education-s3demo-973787`
- バックエンド
  - `src/s3_storage.py` 新規作成（upload / list / delete / status）
  - `main.py` に S3 用 API 追加（POST /api/s3/upload, GET /api/s3/status, DELETE /api/s3/file/{key}）
- フロントエンド
  - `api.ts` に s3Upload / s3Status / s3Delete 追加
  - `DataTab.tsx` を S3 専用 UI に変更（ドラッグ&ドロップ、ファイル一覧、削除）

### 【02:00】Bedrock KB ハンズオン完了
- S3 汎用バケット作成 → データアップロード
- S3 ベクトルバケット作成 → ベクトルインデックス作成（1024次元, Cosine）
- Bedrock KB 作成（Titan Text Embeddings V2）
- データソース同期 → テスト完了

### 【02:30】Bedrock KB 問い合わせ機能を実装
- バックエンド
  - `src/bedrock_kb.py` 新規作成
    - `ask()`: RetrieveAndGenerate API（検索 + 回答生成）
    - `retrieve()`: Retrieve API（検索のみ）
  - `main.py` に POST /api/ask/bedrock 追加
- フロントエンド
  - `AskTab.tsx` を Bedrock KB 専用 UI に変更

### 【03:00】ローカル RAG UI を削除
- `AskTab.tsx`: ローカル/Bedrock 切替トグル削除、Bedrock KB 専用に統一
- `DataTab.tsx`: ローカルアップロード UI 削除、S3 専用に統一

### 【03:30】クイズ・問題演習を Bedrock KB 対応に修正
- `bedrock_kb.py` に `get_contents_for_quiz()` 追加
  - ランダムトピッククエリ（10種）で KB からコンテンツ取得
- `quiz_engine.py`: `get_all_docs()` → `get_contents_for_quiz()` に差し替え
- `practice_engine.py`: 同上
- `main.py`: クイズ・演習エンドポイントに ValueError ハンドリング追加

### 【04:00】Gemini API キー漏洩 → LLM を Bedrock に完全移行
- **問題**: GOOGLE_API_KEY が漏洩フラグで無効化（403 PERMISSION_DENIED）
- **対応**: `llm_client.py` を全面書き換え
  - Gemini → Bedrock Converse API に変更
  - `_BedrockLLM` ラッパークラス（既存の `.invoke()` 互換）

### 【04:30】Anthropic モデルアクセスエラー → Amazon Nova に切替
- **問題**: Claude 3.5 Sonnet の直接呼出しにユースケースフォーム提出が必要（ResourceNotFoundException）
  - KB の `retrieve_and_generate` も同様のエラー
- **対応**:
  - `llm_client.py`: Converse API + `us.amazon.nova-lite-v1:0` に変更
  - `.env`: BEDROCK_MODEL_ARN を `amazon.nova-lite-v1:0` に変更
  - フォーム不要の Amazon 自社モデルで即時利用可能に

### 【05:00】コードベース全体レビュー＆クリーンアップ
- **main.py**
  - `rag_engine`, `ingest` の import 削除（Gemini/ChromaDB 依存排除）
  - ローカル RAG 用エンドポイント 4 つ削除（/api/ask, /api/upload, /api/data/status, /api/data/source/）
  - `/api/health` を S3 + Bedrock KB ステータスに変更
- **config.py**
  - 未使用設定削除（CHROMA_DIR, EMBEDDING_MODEL, CHROMA_COLLECTION, CHROMA_S3_BUCKET）
- **api.ts**
  - デッド関数・型定義削除（ask, uploadFile, getDataStatus, deleteSource, UploadResponse, DataStatusResponse）
- **App.tsx**
  - `chunks_loaded` → `s3_files` に修正（health レスポンス形式変更対応）
- **.env**
  - 漏洩済み GOOGLE_API_KEY を削除

---

## 最終アーキテクチャ

```
[ユーザー] → [React Frontend] → [FastAPI Backend]
                                       │
                    ┌──────────────────┼──────────────────┐
                    ↓                  ↓                  ↓
              S3 バケット        Bedrock KB          Amazon Nova
           (データソース)     (RAG 検索+生成)     (クイズ・演習生成)
                    │                  │
                    ↓                  ↓
              S3 Vectors          Titan Embeddings V2
           (ベクトルストア)        (ベクトル化)
```

## 使用 AWS サービス
| サービス | 用途 |
|---|---|
| S3（汎用バケット） | RAG データソース格納 |
| S3 Vectors（ベクトルバケット） | ベクトルストア |
| Bedrock Knowledge Bases | RAG オーケストレーション |
| Titan Text Embeddings V2 | テキスト → ベクトル変換 |
| Amazon Nova Lite | クイズ・演習問題の LLM 生成 + KB 回答生成 |

## 今日の学び
1. **Bedrock KB はノーコードで RAG を構築できる** — チャンキング・ベクトル化を自動処理
2. **S3 Vectors は S3 にネイティブなベクトルストア** — 別途 DB 不要
3. **Anthropic モデルはユースケースフォーム必須** — Amazon Nova なら即利用可
4. **Converse API はモデル非依存** — モデル切替がパラメータ変更だけで済む
5. **API キーの漏洩は即座にブロックされる** — .env をコミットしない運用が重要

## 残課題
- [ ] Bedrock KB データソースの同期は手動（コンソール操作）→ API 化を検討
- [ ] Amazon Nova Lite の日本語品質を評価 → 必要に応じてモデルアップグレード
- [ ] requirements.txt から不要パッケージ整理（langchain-google-genai, chromadb）
