# 基本設計書

## RAG教育クイズアプリ

| 項目       | 内容                         |
| ---------- | ---------------------------- |
| 作成日     | 2026/02/16                   |
| バージョン | 2.0                          |

---

## 1. システム構成図

### 1.1 ローカル開発構成

```
┌─────────────────────────────────────────────────────────┐
│                     ブラウザ (Chrome)                     │
│  ┌─────────────────────────────────────────────────────┐ │
│  │       Vite + React + TypeScript フロントエンド       │ │
│  │              http://localhost:3000                   │ │
│  │                                                     │ │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────────────┐ │ │
│  │  │QA画面  │ │演習    │ │クイズ  │ │学習記録      │ │ │
│  │  │(質問)  │ │(4択)   │ │(5問)   │ │(ダッシュ     │ │ │
│  │  │        │ │        │ │        │ │ ボード)      │ │ │
│  │  └────────┘ └────────┘ └────────┘ └──────────────┘ │ │
│  └──────────────────────┬──────────────────────────────┘ │
└─────────────────────────┼────────────────────────────────┘
                          │ HTTP (REST API)
                          ▼
┌─────────────────────────────────────────────────────────┐
│              Python バックエンド (FastAPI)                │
│              http://localhost:7000                        │
│                                                          │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐ │
│  │/api/ask   │ │/api/quiz  │ │/api/      │ │/api/me  │ │
│  │質問応答   │ │/generate  │ │practice   │ │/stats   │ │
│  │           │ │/evaluate  │ │/generate  │ │学習統計  │ │
│  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └────┬────┘ │
│        │             │             │              │      │
│  ┌─────▼─────────────▼─────────────▼──────────────┘     │
│  │              RAG パイプライン                          │
│  │  ① クエリ解析  ② ベクトル検索  ③ コンテキスト構築   │
│  │  ④ LLM回答生成 / クイズ生成 / 判定                   │
│  └──────┬────────────────────────────┬───────────────────┘
│         │                            │                    │
│  ┌──────▼───────┐             ┌──────▼───────┐           │
│  │  ChromaDB    │             │  Gemini API  │           │
│  │ (ベクトルDB) │             │  (LLM +      │           │
│  │              │             │   Embedding) │           │
│  └──────────────┘             └──────────────┘           │
└─────────────────────────────────────────────────────────┘
          │                               │
          │                     ┌─────────▼──────────┐
          │                     │  Firebase           │
          │                     │  ├ Auth (認証)      │
          │                     │  └ Firestore (履歴) │
          │                     └────────────────────┘
```

### 1.2 AWS クラウド構成（本番・Free Tier）

```
ユーザー (ブラウザ)
    │
    ▼
┌──────────────────────┐
│  S3 Static Website   │ ← Vite ビルド済み静的ファイル
│  (フロントエンド)    │   http://rageducation-frontend.s3-website-ap-northeast-1.amazonaws.com
└──────────┬───────────┘
           │ HTTPS
           ▼
┌──────────────────────┐     ┌──────────────────────────┐
│  API Gateway (HTTP)  │────>│  AWS Lambda              │
│                      │     │  (FastAPI + Mangum)      │
└──────────────────────┘     │                          │
                             │  ┌────────────────────┐  │
                             │  │ RAGパイプライン     │  │
                             │  │ ① クエリ解析       │  │
                             │  │ ② ベクトル検索     │  │
                             │  │   (embeddings.json) │  │
                             │  │ ③ コンテキスト構築 │  │
                             │  │ ④ Gemini API呼出   │  │
                             │  └──┬─────────────┬───┘  │
                             └─────┼─────────────┼──────┘
                                   │             │
                    ┌──────────────┘             └──────────────┐
                    ▼                                           ▼
        ┌───────────────────┐                      ┌───────────────────┐
        │  S3               │                      │  Gemini API       │
        │  (rageducation-   │                      │  (LLM + Embedding)│
        │   data)           │                      │                   │
        │  └ embeddings.json│                      │  gemini-2.5-flash │
        └───────────────────┘                      │  gemini-embedding │
                                                   │  -001             │
                                                   └───────────────────┘
                                                            │
                                              ┌─────────────┘
                                              ▼
                                   ┌───────────────────┐
                                   │  Firebase          │
                                   │  ├ Auth (認証)     │
                                   │  └ Firestore (履歴)│
                                   └───────────────────┘
```

### 1.3 サービス対応表

| レイヤー         | ローカル開発             | AWS本番（Free Tier）                   |
| ---------------- | ------------------------ | -------------------------------------- |
| フロントエンド   | Vite dev server (:3000)  | **S3 Static Website Hosting**          |
| API ゲートウェイ | 直接接続                 | **API Gateway (HTTP API)**             |
| バックエンド     | FastAPI (:7000)          | **AWS Lambda** (Mangum)                |
| LLM              | Gemini API               | **Gemini API** (同じ)                  |
| Embedding        | Gemini Embedding API     | **Gemini Embedding API** (同じ)        |
| ベクトル検索     | ChromaDB (ファイル)      | **SimpleVectorStore** (embeddings.json)|
| 認証             | Firebase Auth            | **Firebase Auth** (同じ)               |
| 学習履歴         | Firestore                | **Firestore** (同じ)                   |
| データ保管       | ローカル `data/`         | **S3** (rageducation-data)             |

---

## 2. 画面設計

### 2.1 ログイン画面

```
┌────────────────────────────────────────┐
│                                        │
│          RAG Education                 │
│          新人教育クイズアプリ           │
│                                        │
│    ┌──────────────────────────────┐    │
│    │ メールアドレス               │    │
│    └──────────────────────────────┘    │
│    ┌──────────────────────────────┐    │
│    │ パスワード                   │    │
│    └──────────────────────────────┘    │
│                                        │
│    [ ログイン ] / [ アカウント作成 ]    │
│                                        │
│    ────── または ──────                 │
│                                        │
│    [ Google でログイン ]               │
│                                        │
└────────────────────────────────────────┘
```

### 2.2 メイン画面（サイドバー + コンテンツ）

```
┌──────────┬──────────────────────────────┐
│ サイドバー│ ヘッダー（タブ名+説明）      │
│          ├──────────────────────────────┤
│ RAG      │                              │
│ Education│  コンテンツ領域              │
│          │                              │
│ ─ Input ─│  ※ 選択タブに応じて          │
│ ○質問する│    以下が表示される          │
│ ○問題演習│                              │
│          │  - QA画面                    │
│ ─Output ─│  - 問題演習画面              │
│ ○クイズ  │  - クイズ画面（5問セット）    │
│          │  - 学習記録ダッシュボード      │
│ ─Record ─│                              │
│ ○学習記録│                              │
│          │                              │
│ ─────── │                              │
│ ユーザー │                              │
│ 情報     │                              │
│ [ログアウト]                             │
│ API接続● │                              │
└──────────┴──────────────────────────────┘
```

### 2.3 クイズ画面（5問セット）

```
┌──────────────────────────────────────────┐
│  第 3 問 / 5       2 正解                │
│  ████████░░░░░░░░ (40%)                  │
│                                          │
│  [初級] [一問一答]       q_abc12345      │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │ Q  AIの学習における「教師あり      │  │
│  │    学習」とは何ですか？            │  │
│  └────────────────────────────────────┘  │
│                                          │
│  💡 ヒントを見る                          │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │ あなたの回答を入力してください...  │  │
│  │                                    │  │
│  │                                    │  │
│  └────────────────────────────────────┘  │
│                                          │
│  [ 回答する ]           [ やめる ]       │
└──────────────────────────────────────────┘

【5問完了後の正答率画面】
┌──────────────────────────────────────────┐
│              正答率                       │
│                                          │
│              80%                         │
│                                          │
│           素晴らしい！                   │
│                                          │
│  ┌──────┐  ┌──────┐  ┌──────────┐      │
│  │  4   │  │  1   │  │  82      │      │
│  │ 正解 │  │不正解│  │平均スコア│      │
│  └──────┘  └──────┘  └──────────┘      │
│                                          │
│  各問の結果:                             │
│  [1] ○ RAGとは何ですか？     100点      │
│  [2] ○ Embeddingの役割は？    90点      │
│  [3] × フロントエンドとは？    20点     │
│  [4] ○ AIの学習方法は？       80点      │
│  [5] ○ バックエンドの役割は？ 100点     │
│                                          │
│  [ もう一度チャレンジ ]    [ 終了 ]      │
└──────────────────────────────────────────┘
```

---

## 3. データフロー

### 3.1 質問応答フロー

```
ユーザー           React            FastAPI         ベクトル検索    Gemini API
  │                  │                 │                │              │
  │ 質問入力         │                 │                │              │
  │─────────────────>│                 │                │              │
  │                  │ POST /api/ask   │                │              │
  │                  │ + Bearer token  │                │              │
  │                  │────────────────>│                │              │
  │                  │                 │ Embedding生成  │              │
  │                  │                 │───────────────────────────────>│
  │                  │                 │ クエリベクトル │              │
  │                  │                 │<───────────────────────────────│
  │                  │                 │ コサイン類似度 │              │
  │                  │                 │───────────────>│              │
  │                  │                 │ 関連チャンク   │              │
  │                  │                 │<───────────────│              │
  │                  │                 │ プロンプト＋回答要求          │
  │                  │                 │───────────────────────────────>│
  │                  │                 │           回答テキスト        │
  │                  │                 │<───────────────────────────────│
  │                  │ 回答+出典JSON   │                │              │
  │                  │<────────────────│                │              │
  │ 回答表示         │                 │                │              │
  │<─────────────────│                 │                │              │
```

### 3.2 クイズフロー（5問セット）

```
ユーザー           React            FastAPI         チャンクDB     Gemini API
  │                  │                 │                │              │
  │ 難易度選択       │                 │                │              │
  │ [5問スタート]    │                 │                │              │
  │─────────────────>│                 │                │              │
  │                  │                 │                │              │
  │ ┌─── 5回繰り返し ──────────────────────────────────────────────┐  │
  │ │                │ POST /api/quiz  │                │           │  │
  │ │                │ /generate       │                │           │  │
  │ │                │────────────────>│                │           │  │
  │ │                │                 │ ランダム取得   │           │  │
  │ │                │                 │───────────────>│           │  │
  │ │                │                 │ チャンク群     │           │  │
  │ │                │                 │<───────────────│           │  │
  │ │                │                 │ クイズ生成（ランダム形式） │  │
  │ │                │                 │──────────────────────────>│  │
  │ │                │                 │          問題テキスト     │  │
  │ │                │                 │<──────────────────────────│  │
  │ │                │ 問題JSON        │                │           │  │
  │ │                │<────────────────│                │           │  │
  │ │ Q表示          │                 │                │           │  │
  │ │<───────────────│                 │                │           │  │
  │ │                │                 │                │           │  │
  │ │ 回答入力       │                 │                │           │  │
  │ │───────────────>│                 │                │           │  │
  │ │                │ POST /api/quiz  │                │           │  │
  │ │                │ /evaluate       │                │           │  │
  │ │                │────────────────>│                │           │  │
  │ │                │                 │ 判定プロンプト │           │  │
  │ │                │                 │──────────────────────────>│  │
  │ │                │                 │           判定結果        │  │
  │ │                │                 │<──────────────────────────│  │
  │ │                │                 │ Firestore保存  │           │  │
  │ │                │ 判定+解説JSON   │                │           │  │
  │ │                │<────────────────│                │           │  │
  │ │ 結果表示       │                 │                │           │  │
  │ │<───────────────│                 │                │           │  │
  │ │ [次の問題へ]   │                 │                │           │  │
  │ └────────────────────────────────────────────────────────────┘  │
  │                  │                 │                │              │
  │ 正答率表示       │                 │                │              │
  │ (フロント集計)   │                 │                │              │
  │<─────────────────│                 │                │              │
```

---

## 4. ディレクトリ構成

```
RAG_education/
├── docs/                              # ドキュメント
│   ├── 00_requirements_overview.md      # PM要件整理
│   ├── 01_requirements.md               # 要件定義書
│   ├── 02_basic_design.md               # 基本設計書（本書）
│   └── 03_api_design.md                 # API設計書
│
├── frontend/                          # Vite + React + TypeScript
│   ├── package.json
│   ├── vite.config.ts
│   ├── index.html
│   ├── .env                             # Firebase設定 + API URL
│   ├── src/
│   │   ├── main.tsx                     # エントリポイント
│   │   ├── App.tsx                      # ルート（サイドバー + タブ切替）
│   │   ├── index.css                    # Tailwind + カスタムCSS
│   │   ├── contexts/
│   │   │   └── AuthContext.tsx           # Firebase認証コンテキスト
│   │   ├── pages/
│   │   │   └── LoginPage.tsx            # ログイン/サインアップ画面
│   │   ├── components/
│   │   │   ├── AskTab.tsx               # QA質問応答タブ
│   │   │   ├── QuizTab.tsx              # クイズタブ（5問セット）
│   │   │   ├── PracticeTab.tsx          # 問題演習タブ（4択）
│   │   │   └── DashboardTab.tsx         # 学習記録ダッシュボード
│   │   └── lib/
│   │       ├── api.ts                   # バックエンドAPI呼び出し
│   │       └── firebase.ts              # Firebase初期化
│   └── dist/                            # ビルド出力
│
├── backend/                           # Python バックエンド
│   ├── requirements.txt                 # ローカル用依存関係
│   ├── requirements-lambda.txt          # Lambda用軽量依存関係
│   ├── main.py                          # FastAPI エントリポイント
│   ├── lambda_handler.py                # Lambda ハンドラ (Mangum)
│   ├── .env                             # API キー等
│   ├── src/
│   │   ├── __init__.py
│   │   ├── config.py                    # 設定定数 + プロンプトローダー
│   │   ├── models.py                    # Pydantic リクエストモデル
│   │   ├── llm_client.py                # LLMクライアント (Gemini)
│   │   ├── rag_engine.py                # RAG検索 + 回答生成
│   │   ├── vector_store.py              # 軽量ベクトルストア (Lambda用)
│   │   ├── quiz_engine.py               # クイズ生成・判定
│   │   ├── practice_engine.py           # 4択問題演習
│   │   ├── firebase_app.py              # Firebase Admin SDK 初期化
│   │   ├── auth.py                      # 認証ミドルウェア
│   │   └── history.py                   # Firestore 学習履歴
│   ├── prompts/                         # プロンプトテンプレート
│   │   ├── qa.txt                       # QA回答用プロンプト
│   │   ├── quiz_generate.txt            # クイズ生成用プロンプト
│   │   ├── quiz_evaluate.txt            # クイズ判定用プロンプト
│   │   └── practice_generate.txt        # 問題演習生成用プロンプト
│   ├── scripts/                         # ユーティリティスクリプト
│   │   ├── build_vectordb.py            # ChromaDB構築
│   │   ├── export_embeddings.py         # embeddings.json エクスポート
│   │   └── test_search.py              # 検索精度テスト
│   ├── data/                            # チャンクJSON + embeddings
│   │   ├── rag_ai_manual_chunks.json
│   │   └── embeddings.json
│   └── chroma_db/                       # ローカルChromaDB
│
├── deploy/                            # デプロイ関連
│   ├── trust-policy.json                # Lambda IAM ロール
│   ├── s3-policy.json                   # S3 読取ポリシー
│   ├── bucket-policy.json               # フロントS3公開ポリシー
│   ├── lambda-env.json                  # Lambda環境変数
│   ├── deploy_lambda.ps1                # デプロイスクリプト (Windows)
│   └── deploy_lambda.sh                 # デプロイスクリプト (Linux/Mac)
│
├── firestore.rules                    # Firestore セキュリティルール
└── .gitignore
```

---

## 5. 使用モデル・サービス

### 5.1 LLM / Embedding

| 用途          | モデル                       | 備考                         |
| ------------- | ---------------------------- | ---------------------------- |
| LLM（回答）  | Gemini 2.5 Flash             | Google AI API経由・高速      |
| Embedding     | Gemini Embedding 001         | 3072次元・日本語対応         |
| ベクトルDB    | ChromaDB (ローカル)          | ローカルファイル永続化       |
| 軽量検索      | SimpleVectorStore (Lambda)   | embeddings.json + コサイン類似度 |

### 5.2 Firebase

| サービス      | 用途                         | 備考                         |
| ------------- | ---------------------------- | ---------------------------- |
| Authentication| ユーザー認証                 | メール/PW + Google           |
| Firestore     | 学習履歴保存                 | quiz_history / practice_history / stats |

### 5.3 AWS (Free Tier)

| サービス        | 用途                         | 備考                         |
| --------------- | ---------------------------- | ---------------------------- |
| Lambda          | バックエンド実行             | Python 3.12, 512MB, 60秒    |
| API Gateway     | HTTP API ルーティング        | ANY /{proxy+}                |
| S3 (data)       | embeddings.json 保管         | rageducation-data            |
| S3 (frontend)   | 静的サイトホスティング       | rageducation-frontend        |

---

## 6. AWS デプロイ構成

### 6.1 前提条件

- AWSアカウント作成済み（Free Tier）
- AWS CLI インストール済み & `aws configure` 設定済み
- Firebase プロジェクト設定済み（Auth + Firestore）
- Gemini API キー取得済み
- リージョン: `ap-northeast-1`（東京）

### 6.2 デプロイ済みリソース

| リソース | 識別子 / URL |
| -------- | ------------ |
| Lambda関数 | `rageducation-api` |
| IAMロール | `rageducation-lambda-role` |
| API Gateway | `yequzq6pn2` (`https://yequzq6pn2.execute-api.ap-northeast-1.amazonaws.com`) |
| S3 (データ) | `rageducation-data` |
| S3 (フロント) | `rageducation-frontend` |
| フロントURL | `http://rageducation-frontend.s3-website-ap-northeast-1.amazonaws.com` |

### 6.3 Lambda 環境変数

| 変数名             | 説明                             |
| ------------------ | -------------------------------- |
| APP_ENV            | `lambda`（環境識別）             |
| GOOGLE_API_KEY     | Gemini API キー                  |
| FIREBASE_PROJECT_ID| Firebase プロジェクトID          |
| CHROMA_S3_BUCKET   | `rageducation-data`（データバケット）|
| CORS_ORIGINS       | フロントエンドのURL              |
| FIREBASE_SA_JSON   | サービスアカウントJSON（文字列） |

### 6.4 ローカル → Lambda の切替ポイント

```python
# config.py
APP_ENV = os.getenv("APP_ENV", "local")  # "local" or "lambda"

# rag_engine.py: ベクトル検索の切替
if APP_ENV == "lambda":
    # SimpleVectorStore (embeddings.json を S3 からダウンロード)
else:
    # ChromaDB (ローカルファイル)
    # ※ embeddings.json があればそちらも利用可能
```

---

## 変更履歴

| 日付       | バージョン | 内容                      |
| ---------- | ---------- | ------------------------- |
| 2026/02/16 | 1.0        | 初版作成                  |
| 2026/02/16 | 1.1        | AWS構成追加（Bedrock/Lambda/Amplify） |
| 2026/02/16 | 2.0        | 実装に合わせ全面改訂（Gemini/Firebase/5問クイズ/S3デプロイ） |
